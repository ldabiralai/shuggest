<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/normalize.css">
    <link rel="stylesheet" href="/css/skeleton.css">
    <link rel="stylesheet" href="/css/app.css">
</head> 
<body>
<div class="container">

    <div id=login>
        <h2>make a suggestion to a friend</h2>
        <fb:login-button size="xlarge" scope="public_profile,email,user_friends" onlogin="FB.getLoginStatus(handleFBLoginStatus)">Log in with Facebook
        </fb:login-button>
    </div>    

    <div class="u-full-width make-a-suggestion-toggle"><a href="#">make a suggestion to a friend</a></div>
    <div id=make-a-suggestion>
        <h2>make a suggestion to a friend</h2>
        <form id=makeSuggestion>

            <div class="row">
                <select id="category" name="category" class="two columns">
                    <option>movie</option>
                    <option>show</option>
                    <option>book</option>
                    <option>game</option>
                    <option>other</option>
                </select>   
                <span class="six columns suggestion-span">
                    <input id=suggestion type=text class="u-full-width" name="suggestion" placeholder="your suggestion" autocomplete="off">
                    <div class='imdb-search'></div>
                </span>
            </div>    

            <div class="row">
                <input id=suggestion-url type=url class="twelve columns" name="url" placeholder="a url about your suggestion, e.g. imdb">
            </div>

            <div class="row">
                <select id=fbname type=text class="six columns select-with-placeholder" name="fbname">
                    <option disabled selected class=placeholder>friend</option>
                </select>    
                <input type=hidden name=fbid>
                <div class="four columns invite-link"> <a href="#" class="invite-fb-friend">invite facebook friend</a></div>
            </div>

            <div class="row">
                <input type=hidden name=fromfbname>
                <input type=hidden name=fromfbid>
                <button id=send-button class="btn send" disabled>send</button>
                <button class="button-primary suggestionResult" disabled>thanks</button>
            </div>

        </form>
    </div>

    <div id=my-suggestions>
        <h2>suggestions for you <span class=current-user></span> <a href="#" class="logout">logout</a></h2>
        <div class="suggestions u-full-width"></div>    
    </div>

</div>  
<div id="status">
</div>

</body> 

<script id="facebook-jssdk" src="//connect.facebook.net/en_US/sdk.js"></script>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="/js/sugar.min.js"></script>
<script>
    FB.init({
      appId      : '1555610558025917',
      xfbml      : true,
      version    : 'v2.2'
    });
</script>
<script>

    $(function(){

        FB.getLoginStatus(handleFBLoginStatus);


        $('#makeSuggestion input').blur(function(){
            $('.send').prop('disabled', false);
        })

        $('#makeSuggestion').submit(function(e){
            e.preventDefault();
            $('#makeSuggestion .send').hide();
            $('#makeSuggestion input[name=fromfbname]').val(currentUser().name)
            $('#makeSuggestion input[name=fromfbid]').val(currentUser().id)
            $.post("makeSuggestion", $(this).serialize() , function( data ) {
                $('.suggestionResult').show();  
                $('#makeSuggestion input').val('');
                $('#makeSuggestion .send').delay(3000).slideDown("fast");   
                $('.suggestionResult').delay(2500).slideUp("fast"); 
                refreshView();
            });
        });


        $('#suggestion').keyup(function(e){
            if ($(this).val().length < 1) {
                $('.imdb-search').hide();
                return;
            }    
            if (!($('#category').val() == 'movie' || $('#category').val() == 'show')) return;

            var query = $(this).val().toLowerCase().replace(/ /g, '_');;
            var firstLetter = query.substring(0,1);
            var queryURL = 'http://sg.media-imdb.com/suggests/'+firstLetter+'/'+query+'.json'
            
            $.ajax({
                url: queryURL,
                dataType: 'jsonp',
                jsonp: false,
                jsonpCallback: 'imdb$'+query
            })
            .done(function(data){
                console.log(data)
                var html = ""
                data.d.each(function(i){
                    if ($('#category').val() == "movie" && i.q == "feature") {
                        html += makeImdbResultLink(i);
                    }
                    if ($('#category').val() == "show" && i.q == "TV series") {
                        html += makeImdbResultLink(i);
                    }
                })
                html += ""
                if (html) {
                    $('.imdb-search').html(html);
                    $('.imdb-search').slideDown("fast");
                }    
            })
        });

         $('body').on('click', '.imdb-query-result a', function(e){
             e.preventDefault();
             $('#suggestion').val($(this).parent().text())
             $('#suggestion-url').val("http://www.imdb.com/title/"+$(this).data('id'))
         });

         $('body').on('click', function(e){
             $('.imdb-search').hide();
         });


        $('.make-a-suggestion-toggle a').click(function(e){
            e.preventDefault();
            toggleMakeASuggestion();
        });

        $('.logout').click(function(e){
            e.preventDefault();
            logout();
        });

        $('.invite-fb-friend').click(function(e){
            e.preventDefault();
            FB.ui({method: 'apprequests',
                  message: "Hi, I want to suggest a " + $('#category').val() + " to you. Login at http://mastaf.herokuapp.com to see what it is."
                }, function(response){
                    $('#fbid').val(response.to[0])
            });
            
        });


        $('body').on('click', '.more', function(e){
            e.preventDefault();
            e.stopPropagation();
            if ($('.more-box').length) 
                removeMoreBox();
             else 
                $(this).parent().append(makeMoreBox());
        });

        $('body').on('click', removeMoreBox);

        $('body').on('click', '.remove', function(e){
            e.preventDefault();
            var suggestion = $(this).closest('tr');
            $.post('/remove', {id: suggestion.data('id')}, function(){
                refreshView();
            }); 
            
        });

        $('#fbname').change(function(){
           $('#fbname').removeClass('select-with-placeholder');
           $('input[name=fbid]').val($("#fbname option:selected").data('fbid'))
        })



    })


    function currentUser() {
        return JSON.parse(localStorage.currentUser);
    }

    function handleFBLoginStatus(response) {
      if (response.status == 'connected') {
        FB.api('/me', function(response) {
            localStorage.currentUser = JSON.stringify(response);
            determineLogin();
        }); 
        FB.api('/me/friends', function(response) {
            if(response.data.length > 0) {
                response.data.each(function(friend){
                    addToFriendList(friend);
                }) 
            } else {
                $('#fbname').hide();
                $('#send-button').hide();
            } 

        })
      } else {
        determineLogin();
      }
    }

    function determineLogin() {   
        if (localStorage.currentUser){
            showLoggedIn(); 
            hideLogin();
        } else {
            hideLoggedIn();
            showLogin();
        }
    }

    function addToFriendList(friend) {
        var html = "<option data-fbid='"+friend.id+"'>"+friend.name+"</option>"
        $('#fbname').append(html);
    }

    function showLoggedIn() {
         $('.make-a-suggestion-toggle').show();
         viewSuggestions();
    }

    function hideLoggedIn() {
         $('.make-a-suggestion-toggle').hide();
         $("#my-suggestions").hide(); 
    }


    function refreshView() {
        viewSuggestions();
    }

    function viewSuggestions(){    
        $("#my-suggestions").show(); 
        $.get("suggestions/"+currentUser().id, function( data ) {

            $('.suggestions').html(renderSuggestions(data)).show();
        
        });

         $('.current-user').text(currentUser().name);
    }

    function renderSuggestions(suggestions) {
        var allhtml = "";

        var arr = ['movie', 'show', 'book', 'game', 'other']
        arr.each(function(category) {
            allhtml += renderSuggestionsOfCategory(category);
        })

        function renderSuggestionsOfCategory(category) {
            var html = ""
            if (suggestions.any({category: category})) {
                html += "<table class=u-full-width><thead><tr><th>"+category+"s</th></tr></thead><tbody>"
                suggestions.findAll({category: category}).each(function(i){
                   html += "<tr data-id='"+i._id+"'><td>"
                   if (i.url) html += makeLink(i.suggestion, i.url)
                   else html += i.suggestion
                   html += "<a href='#' class='more u-pull-right'>&hellip;</a>" 
                   if (i.fromfbname) html += " <div class=from-user>suggested by "+i.fromfbname+"</div>"
                   html += "</td></tr>"
                })
                html += "</tbody></table>"  
            }
            return html
        }
            
        return allhtml;
    } 

    function makeLink(text, href) {
        if (!href.startsWith("http://")) href = href.insert("http://", 0)
        return "<a href='"+href+"'>"+text+"</a>"
    }

    function toggleMakeASuggestion() {
        if ($('.make-a-suggestion-toggle a').text() != 'hide') {
            showMakeASuggestion();
        }
        else {
            hideMakeASuggestion();
        }   
    }

    function showMakeASuggestion() {
        $('.make-a-suggestion-toggle a').text('hide')
        $('#make-a-suggestion').slideDown();    
    }

    function hideMakeASuggestion() {
        $('#make-a-suggestion').slideUp();  
        $('.make-a-suggestion-toggle a').text('make a suggestion to a friend');
    }

    function removeMoreBox() {
        if ($('.more-box').length) {
           $('.more-box').remove(); 
        } 
    }

    function makeMoreBox() {
        return "<div class='more-box'><a href='#' class='remove'>remove</a></div>";
    }

    function logout() {
        localStorage.currentUser = "";
        FB.logout(function(response) {
            determineLogin();
        });
    }

    function makeImdbResultLink(i){
       return "<div class='imdb-query-result'><a href='#' data-id='"+i.id+"''>" + i.l +"</a> <span class=year> ("+i.y+")</span></div>"
    }

    function showLogin() {
        $('#login').show();
    }

    function hideLogin() {
        $('#login').hide();
    }


</script>



