<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/normalize.css">
	<link rel="stylesheet" href="/css/skeleton.css">
	<link rel="stylesheet" href="/css/app.css">
</head>	
<body>
<div class="container">
	<div class="u-full-width make-a-suggestion-toggle"><a href="#">make a suggestion to a friend</a></div>
	<div id=make-a-suggestion>
		<h2>make a suggestion to a friend</h2>
		<form id=makeSuggestion>

			<input id=username type=text class="four columns" name="username" placeholder="friend's email">
			<select name="category" class="two columns">
				<option>movie</option>
				<option>show</option>
				<option>book</option>
				<option>game</option>
				<option>other</option>
			</select>	
			<input id=suggestion type=text class="six columns" name="suggestion" placeholder="your suggestion">
			<div class="row">
				<input id=suggestion-url type=text class="twelve columns" name="url" placeholder="a url about your suggestion, e.g. imdb">
			</div>
			
	        <input type=hidden name=from>
	        <button class="btn send">send</button>
			<button class="button-primary suggestionResult" disabled>thanks</button>

		</form>
	</div>

	<div id=my-suggestions>
		<h2>see suggestions for you <span class=current-user></span></h2>
		<div class="suggestions u-full-width"></div>	
		<form id=viewSuggestions>
			<input id=my-username type=text name="username" placeholder="your email">    
			<button class="btn">go</button>
		</form>
	</div>
	
</div>	

<footer class=u-full-width><a href="#" onclick='localStorage.currentUser=""; location.reload();'>logout</a></footer>
</body>	

<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="/js/sugar.min.js"></script>
<script>

	$(function(){
		if (localStorage.currentUser){
			viewSuggestions();
			hideMakeASuggestion();
		}

		$('#makeSuggestion').submit(function(e){
			e.preventDefault();
			$('#makeSuggestion .send').hide();
			$('#makeSuggestion input[name=from]').val(localStorage.currentUser)
			$.post("makeSuggestion", $(this).serialize() , function( data ) {
				$('.suggestionResult').show();	
				$('#makeSuggestion input').val('');
			  	$('#makeSuggestion .send').delay(3000).slideDown("fast");	
			  	$('.suggestionResult').delay(2500).slideUp("fast");	
			  	  
			});
		});


		$('#viewSuggestions').submit(function(e){ 
			e.preventDefault();	
			localStorage.currentUser = $('#my-username').val();
			viewSuggestions(); 
			hideMakeASuggestion();
		});


		$('.make-a-suggestion-toggle a').click(function(e){
			e.preventDefault();
			toggleMakeASuggestion();
		})

	})

	function viewSuggestions(){		
		$.get("suggestions/"+localStorage.currentUser, function( data ) {
			$('.suggestions').html(renderSuggestions(data)).show();

			$('.current-user').text(localStorage.currentUser);

			$('#my-username').val('');
			$('#my-username').attr('placeholder', 'see someone else?')
  	  	
		});
	}

	function renderSuggestions(suggestions) {
		var allhtml = "";

		var arr = ['movie', 'show', 'book', 'game', 'other']
		arr.each(function(category) {
			allhtml += renderSuggestionsOfCategory(category);
		})

		function renderSuggestionsOfCategory(category) {
			var html = ""
			if (suggestions.any({category: category})) {
				html += "<table class=u-full-width><thead><tr><th>"+category+"s</th></tr></thead><tbody>"
				suggestions.findAll({category: category}).each(function(i){
				   html += "<tr><td>"
				   if (i.url) html += makeLink(i.suggestion, i.url)
				   else html += i.suggestion
				   if (i.from) html += " <div class=from-user>"+i.from+"</div>"
				   html += "</td></tr>"
				})
				html += "</tbody></table>"	
			}
			return html
		}
			
		return allhtml;
	} 

	function makeLink(text, href) {
		if (!href.startsWith("http://")) href = href.insert("http://", 0)
		return "<a href='"+href+"'>"+text+"</a>"
	}

	function toggleMakeASuggestion() {
		if ($('.make-a-suggestion-toggle a').text() != 'hide') {
			showMakeASuggestion();
		}
		else {
			hideMakeASuggestion();
		}	
	}

	function showMakeASuggestion() {
		$('.make-a-suggestion-toggle a').text('hide')
	    $('#make-a-suggestion').slideDown();	
	}

	function hideMakeASuggestion() {
		$('.make-a-suggestion-toggle').show();
		$('#make-a-suggestion').slideUp();	
		$('.make-a-suggestion-toggle a').text('make a suggestion to a friend');
	}


</script>

